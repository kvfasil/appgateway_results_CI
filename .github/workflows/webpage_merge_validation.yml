
name: Validate and Publish Web Results on Webpage Merge

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name (e.g. webpage)'
        required: true
        default: 'webpage'
      result_dir:
        description: 'Result directory (e.g. develop/BRANCH/PROPOSITION)'
        required: true
      proposition:
        description: 'Proposition (e.g. SCXI11BEI)'
        required: true

jobs:
  validate-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BRANCH: "webpage"
      result_dir: ${{ github.event.inputs.result_dir }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run validation scripts for all TIMESTAMP subdirs in result_dir
        run: |
          set -e
          for DIR in "$result_dir"/*/; do
            [ -d "$DIR" ] || continue
            TIMESTAMP=$(basename "$DIR")
            WEB_RESULT_DIR="$result_dir/web_result"
            mkdir -p "$WEB_RESULT_DIR"
            # Generate Firebolt Core Sanity HTML if present
            if [ -f "$DIR/CoreSanity_SchemaValidation_response.json" ]; then
              python3 .github/scripts/generate_core_sanity_report_js.py "$DIR/CoreSanity_SchemaValidation_response.json"
            fi
            # Generate Badger Sanity HTML if present
            if [ -f "$DIR/BadgerSanity_SchemaValidation_response.json" ]; then
              python3 .github/scripts/generate_badger_sanity_report_js.py "$DIR/BadgerSanity_SchemaValidation_response.json"
            fi
          done

      - name: Commit and push web_result updates
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add "$result_dir"/web_result/*.html || true
          if git diff --cached --quiet; then
            echo "No web_result changes to commit."
          else
            git commit -m "Update web_result HTML after validation on webpage merge"
            git push origin "$BRANCH"
          fi
