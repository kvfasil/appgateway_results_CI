name: Create PR to main after reports

on:
  workflow_run:
    workflows: ["Generate Validation Report HTML"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Create pull request to main
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = context.payload.workflow_run.head_branch;
            const base = 'main';
            const title = `Automated reports PR: ${head} -> ${base}`;
            const body = 'This PR was automatically created after reports generation.';

            // Check for existing open PR from the same head to base
            const existing = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              base,
              per_page: 100
            });
            const match = existing.data.find(pr => pr.head && pr.head.ref === head && pr.base && pr.base.ref === base);
            if (match) {
              core.info(`PR already exists: #${match.number}`);
              return;
            }

            // Create the PR
            const res = await github.rest.pulls.create({ owner, repo, title, head, base, body });
            core.info(`Created PR #${res.data.number}`);
