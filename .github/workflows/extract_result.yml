name: Jira Artifact Extract

on:
  push:
    paths:
      - 'artifacts/*.tar.gz'
    branches:
      - '**'   # trigger on ALL branches (Jira branches)

permissions:
  contents: write

jobs:
  extract-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract artifact and push extracted files to Jira branch
      shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e

        # --------------------------------------------------
        # Jira branch = branch name (artifact already uploaded here)
        # --------------------------------------------------
        JIRA_NUMBER="${GITHUB_REF_NAME}"

        if [ -z "$JIRA_NUMBER" ]; then
          echo "[ERROR] Could not determine Jira branch name"
          exit 1
        fi

        echo "[INFO] Jira branch detected: $JIRA_NUMBER"
        # --------------------------------------------------
        # Generate timestamp folder
        # --------------------------------------------------
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        echo "[INFO] Timestamp: $TIMESTAMP"

        # --------------------------------------------------
        # Extract latest artifact from THIS branch
        # --------------------------------------------------
        mkdir -p extracted
        LATEST_ARTIFACT=$(ls artifacts/*.tar.gz | sort | tail -n1)

        if [ -z "$LATEST_ARTIFACT" ]; then
          echo "ERROR: No artifact found in branch $JIRA_NUMBER"
          exit 1
        fi

        echo "[INFO] Extracting artifact: $LATEST_ARTIFACT"
        tar -xzf "$LATEST_ARTIFACT" -C extracted

        # --------------------------------------------------
        # Prepare Jira/timestamp directory
        # --------------------------------------------------
        FINAL_DIR="$JIRA_NUMBER/$TIMESTAMP"
        mkdir -p "$FINAL_DIR"
        cp -r extracted/* "$FINAL_DIR/"

        echo "[INFO] Prepared directory: $FINAL_DIR"

        # --------------------------------------------------
        # Push extracted files BACK to SAME Jira branch
        # --------------------------------------------------
        echo "[INFO] Listing files in $FINAL_DIR:"
        find "$FINAL_DIR" -type f | while read f; do echo "[INFO] Found file: $f"; done

        find "$FINAL_DIR" -type f | while read FILE; do
          REL_PATH="${FILE#./}"
          echo "[INFO] Processing file: $FILE (relative: $REL_PATH)"
          base64 -w 0 "$FILE" > content.b64
          CONTENT=$(cat content.b64)

          echo "[INFO] Checking for existing file in repo: $REL_PATH"
          SHA=$(curl -s \
            -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/contents/$REL_PATH?ref=$JIRA_NUMBER" \
            | jq -r '.sha // empty')

          if [ -z "$SHA" ]; then
            echo "[INFO] No existing file found. Creating new file: $REL_PATH"
            PAYLOAD=$(jq -n \
              --arg msg "Add $REL_PATH from artifact" \
              --arg content "$CONTENT" \
              --arg branch "$JIRA_NUMBER" \
              '{message: $msg, content: $content, branch: $branch}')
          else
            echo "[INFO] Existing file found (sha: $SHA). Updating: $REL_PATH"
            PAYLOAD=$(jq -n \
              --arg msg "Update $REL_PATH from artifact" \
              --arg content "$CONTENT" \
              --arg branch "$JIRA_NUMBER" \
              --arg sha "$SHA" \
              '{message: $msg, content: $content, branch: $branch, sha: $sha}')
          fi

          echo "[INFO] Sending PUT request to GitHub API for $REL_PATH"
          RESPONSE=$(curl -s -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$PAYLOAD" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/contents/$REL_PATH")
          echo "[INFO] GitHub API response for $REL_PATH: $RESPONSE"
          rm -f content.b64
        done

        echo "âœ… Extracted files pushed to branch $JIRA_NUMBER under $TIMESTAMP"
