name: Jira Artifact Extract

on:
  push:
    paths:
      - 'artifacts/*.tar.gz'
    branches:
      - '**'   # trigger on ALL branches (Jira branches)

permissions:
  contents: write

jobs:
  extract-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract artifact and push extracted files to Jira branch
      shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e

        # --------------------------------------------------
        # Jira branch = branch name (artifact already uploaded here)
        # --------------------------------------------------
        JIRA_NUMBER="${GITHUB_REF_NAME}"

        if [ -z "$JIRA_NUMBER" ]; then
          echo "[ERROR] Could not determine Jira branch name"
          exit 1
        fi

        echo "[INFO] Jira branch detected: $JIRA_NUMBER"
        # --------------------------------------------------
        # Generate timestamp folder
        # --------------------------------------------------
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        echo "[INFO] Timestamp: $TIMESTAMP"

        # --------------------------------------------------
        # Extract latest artifact from THIS branch
        # --------------------------------------------------
        mkdir -p extracted
        LATEST_ARTIFACT=$(ls artifacts/*.tar.gz | sort | tail -n1)

        if [ -z "$LATEST_ARTIFACT" ]; then
          echo "ERROR: No artifact found in branch $JIRA_NUMBER"
          exit 1
        fi

        echo "[INFO] Extracting artifact: $LATEST_ARTIFACT"
        tar -xzf "$LATEST_ARTIFACT" -C extracted

        # --------------------------------------------------
        # Prepare Jira/timestamp directory
        # --------------------------------------------------
        FINAL_DIR="$JIRA_NUMBER/$TIMESTAMP"
        mkdir -p "$FINAL_DIR"
        cp -r extracted/* "$FINAL_DIR/"

        echo "[INFO] Prepared directory: $FINAL_DIR"

        # --------------------------------------------------
        # Push extracted files BACK to SAME Jira branch using git
        # --------------------------------------------------
        echo "[INFO] Adding files to git for branch $JIRA_NUMBER"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add "$FINAL_DIR"
        git commit -m "Add extracted files for $JIRA_NUMBER at $TIMESTAMP" || echo "[INFO] No changes to commit"
        git push origin HEAD:"$JIRA_NUMBER"
        echo "âœ… Extracted files pushed to branch $JIRA_NUMBER under $TIMESTAMP using git"
