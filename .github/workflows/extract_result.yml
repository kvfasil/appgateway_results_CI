name: Jira Artifact Extract

# Trigger workflow when an artifact is pushed
on:
  push:
    paths:
      - 'artifacts/*.tar.gz'
    branches:
      - main   # or the branch where artifacts are pushed

# Ensure the GITHUB_TOKEN can write to repo
permissions:
  contents: write

jobs:
  extract-and-push:
    runs-on: ubuntu-latest
    env:
      GITHUB_REPOSITORY: ${{ github.repository }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:

    # Checkout repo to have access to files
    - name: Checkout repository
      uses: actions/checkout@v3

    # Extract artifact and push to Jira branch
    - name: Extract artifact and push to Jira branch
      shell: bash
      env:
        JIRA_NUMBER: ${{ github.event.head_commit.message }} # Or pass via commit message
      run: |
        set -e

        if [ -z "$JIRA_NUMBER" ]; then
          echo "JIRA_NUMBER not set in commit message!"
          exit 1
        fi

        # Get latest artifact
        mkdir -p extracted
        LATEST_ARTIFACT=$(ls artifacts/*.tar.gz | sort | tail -n1)
        echo "Latest artifact: $LATEST_ARTIFACT"
        tar -xzf "$LATEST_ARTIFACT" -C extracted

        # Check if Jira branch exists
        HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: token $GITHUB_TOKEN" \
          "https://api.github.com/repos/$GITHUB_REPOSITORY/branches/$JIRA_NUMBER")

        if [ "$HTTP_STATUS" -eq 404 ]; then
          echo "Branch $JIRA_NUMBER does not exist. Creating..."
          DEFAULT_SHA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/git/ref/heads/main" | jq -r '.object.sha')

          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"ref\":\"refs/heads/$JIRA_NUMBER\",\"sha\":\"$DEFAULT_SHA\"}" \
            "https://api.github.com/repos/$GITHUB_REPOSITORY/git/refs"

          echo "Branch $JIRA_NUMBER created."
        else
          echo "Branch $JIRA_NUMBER already exists."
        fi

        # Prepare folder for Jira number
        mkdir -p "$JIRA_NUMBER"
        cp -r extracted/* "$JIRA_NUMBER/"

        # Push files to Jira branch via API
        for FILE in $(find $JIRA_NUMBER -type f); do
          REL_PATH="${FILE#./}"
          CONTENT=$(base64 -w 0 "$FILE")
          SHA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/${GITHUB_REPOSITORY}/contents/$REL_PATH?ref=$JIRA_NUMBER" \
                | jq -r '.sha // empty')

          if [ -z "$SHA" ]; then
            PAYLOAD=$(jq -n --arg msg "Add $REL_PATH from artifact" --arg content "$CONTENT" \
                     '{message: $msg, content: $content, branch: "'$JIRA_NUMBER'"}')
          else
            PAYLOAD=$(jq -n --arg msg "Update $REL_PATH from artifact" --arg content "$CONTENT" --arg sha "$SHA" \
                     '{message: $msg, content: $content, branch: "'$JIRA_NUMBER'", sha: $sha}')
          fi

          curl -s -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$PAYLOAD" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/contents/$REL_PATH"
        done

        echo "All files pushed to branch $JIRA_NUMBER"

